<div class="vaarn-character">
  <div class="header">
    <label class="very-large">VAULTS of VAARN</label>
  </div>

  <div class="basics">
    <label>NAME</label><input type="text" name="attr_name"/><br/>

    <label>ANCESTRY</label><select type="text" name="attr_ancestry">
      <option value="truekin">True-Kin</option>
      <option value="synth">Synth</option>
      <option value="newbeast">Newbeast</option>
      <option value="mycomorph">Mycomorph</option>
      <option value="cacogen">Cacogen</option>
    </select>
    <br/>

    <div class="sheet-auto-expand">
      <span name="attr_specialrules"></span>
      <textarea spellcheck="false" name="attr_specialrules"></textarea>
    </div>
  </div>
  
  <div class="bio">
    <label>HP</label><input type="number" name="attr_hp_cur"/>
    <span class="spacer">&nbsp;</span>
    <label>LEVEL</label><input type="number" name="attr_level"/>
    <br/>

    <label>MAX</label><input type="number" name="attr_hp_max"/>
    <span class="spacer">&nbsp;</span>
    <label>ARMOR</label><input type="number" name="attr_armor"/>
    <br/>

    <div class="sheet-auto-expand">
      <span name="attr_bio"></span>
      <textarea spellcheck="false" name="attr_bio" placeholder="bio"></textarea>
    </div>
  </div>

  <div class="clear"></div>

  <div class="header">
    <label class="large">ABILITIES</label>
  </div>

  <div class="labels">
    <label>&nbsp;</label></br>
    <label>BONUS</label></br>
    <label>PENALTY</label></br>
    <label>DEF</label></br>
    <label class="small">CYBERNETIC</label>
  </div>

  <div class="ability">
    <button type="action" name="act_str">STR</button><br/>
    <input type="number" value="0" min="1" max="10" name="attr_str_bonus" required/><br/>
    <input type="number" value="0" min="-20" max="0" name="attr_str_penalty" required/><br/>
    <input type="number" value="10" min="3" max="20" name="attr_str_def" readonly required/><br/>
    <div class="sheet-auto-expand">
      <span name="attr_str_cybernetic"></span>
      <textarea spellcheck="false" name="attr_str_cybernetic"></textarea>
    </div>
  </div>

  <div class="ability">
    <button type="action" name="act_dex">DEX</button><br/>
    <input type="number" value="0" min="1" max="10" name="attr_dex_bonus" required/><br/>
    <input type="number" value="0" min="-20" max="0" name="attr_dex_penalty" required/><br/>
    <input type="number" value="10" min="3" max="20" name="attr_dex_def" readonly required/><br/>
    <div class="sheet-auto-expand">
      <span name="attr_dex_cybernetic"></span>
      <textarea spellcheck="false" name="attr_dex_cybernetic"></textarea>
    </div>
  </div>

  <div class="ability">
    <button type="action" name="act_con">CON</button><br/>
    <input type="number" value="0" min="1" max="10" name="attr_con_bonus" required/><br/>
    <input type="number" value="0" min="-20" max="0" name="attr_con_penalty" required/><br/>
    <input type="number" value="10" min="3" max="20" name="attr_con_def" readonly required/><br/>
    <div class="sheet-auto-expand">
      <span name="attr_con_cybernetic"></span>
      <textarea spellcheck="false" name="attr_con_cybernetic"></textarea>
    </div>
  </div>

  <div class="ability">
    <button type="action" name="act_int">INT</button><br/>
    <input type="number" value="0" min="1" max="10" name="attr_int_bonus" required/><br/>
    <input type="number" value="0" min="-20" max="0" name="attr_int_penalty" required/><br/>
    <input type="number" value="10" min="3" max="20" name="attr_int_def" readonly required/><br/>
    <div class="sheet-auto-expand">
      <span name="attr_int_cybernetic"></span>
      <textarea spellcheck="false" name="attr_int_cybernetic"></textarea>
    </div>
  </div>

  <div class="ability">
    <button type="action" name="act_psy">PSY</button><br/>
    <input type="number" value="0" min="1" max="10" name="attr_psy_bonus" required/><br/>
    <input type="number" value="0" min="-20" max="0" name="attr_psy_penalty" required/><br/>
    <input type="number" value="10" min="3" max="20" name="attr_psy_def" readonly required/><br/>
    <div class="sheet-auto-expand">
      <span name="attr_psy_cybernetic"></span>
      <textarea spellcheck="false" name="attr_psy_cybernetic"></textarea>
    </div>
  </div>

  <div class="ability">
    <button type="action" name="act_ego">EGO</button><br/>
    <input type="number" value="0" min="1" max="10" name="attr_ego_bonus" required/><br/>
    <input type="number" value="0" min="-20" max="0" name="attr_ego_penalty" required/><br/>
    <input type="number" value="10" min="3" max="20" name="attr_ego_def" readonly required/><br/>
    <div class="sheet-auto-expand">
      <span name="attr_ego_cybernetic"></span>
      <textarea spellcheck="false" name="attr_ego_cybernetic"></textarea>
    </div>
  </div>

  <div class="clear"></div>

  <div class="header">
    <label class="large">ITEMS</label>
  </div>

  <div class="item">
    <input type="hidden" class="item-count" name="attr_item_count"/>
    <input type="hidden" class="item-encumbered" name="attr_item_encumbered" max="0"/>
    <input type="hidden" class="item-overloaded" name="attr_item_overloaded" max="0"/>
    <fieldset class="repeating_item">
      <input type="hidden" name="attr_slots" class="item-slots-hidden"/>
      <input type="hidden" name="attr_type" class="item-type-hidden"/>
      <input type="hidden" name="attr_die" class="item-die-hidden"/>
      <label></label><input type="text" name="attr_name" class="item-name"/><input type="number" name="attr_slots" class="item-slots" min="1" max="10" placeholder="slots"/><select name="attr_type" class="item-type">
        <option value="item">Item</option>
        <option value="gift">Mystic Gift</option>
        <option value="wound">Wound</option>
      </select><select name="attr_die" class="item-die">
        <option value="d4">d4</option>
        <option value="d6">d6</option>
        <option value="d8">d8</option>
        <option value="d10">d10</option>
        <option value="d12">d12</option>
        <option value="d20">d20</option>
      </select><span class="spacer"><button disabled>&nbsp;</button><button disabled>&nbsp;</button><button type="action" name="act_item">t</button></span>
    </fieldset>
  </div>

  <div class="header">
    <label class="large">NOTES</label>
  </div>

  <div class="notes">
    <div class="sheet-auto-expand">
      <span name="attr_notes"></span>
      <textarea spellcheck="false" name="attr_notes"></textarea>
    </div>
  </div>
</div>

<rolltemplate class="sheet-rolltemplate-basic">
<div class="sheet-template-container">
  <h1>{{name}}: {{roll1}}</h1>
</div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-complex">
<div class="sheet-template-container">
  <h1>{{name1}}: {{roll1}}</h1>
  <h2>{{name2}}: {{roll2}}</h2>
</div>
</rolltemplate>

<script type="text/worker">
  function rollMacro(macro) {
    startRoll(macro, results => { finishRoll(results.rollId); });
  }

  function dieMacro(name, die, bonus, penalty) {
    let macro = "{{" + name + "=[[" + die;
    if (bonus !== undefined) { macro += " + " + bonus; }
    if (penalty !== undefined) { macro += " - " + penalty; }
    macro += "]]}}";

    return macro;
  }

  function roll(name1, macro1, name2, macro2) {
    if (name2 === undefined) {
      return rollMacro("&{template:basic} {{name=" + name1 + "}} " + macro1);
    } else {
      return rollMacro("&{template:complex} {{name1=" + name1 + "}} " + macro1 + " {{name=" + name2 + "}} " + macro2);
    }
  }

  function rollAbility(die, ability) {
    const ability_bonus = ability + "_bonus";
    const ability_penalty = ability + "_penalty";

    getAttrs([ability_bonus, ability_penalty], values => {
      const abilityDisplay = ability.toUpperCase();
      const bonus = parseInt(values[ability_bonus]) || 0;
      const penalty = -1 * parseInt(values[ability_penalty]) || 0;

      roll(abilityDisplay, dieMacro("roll1", die, bonus, penalty));
    });
  }

  function rollItem(die, item) {
    roll(item, dieMacro("roll1", die));
  }

  on("clicked:str", info => { rollAbility("d20", "str"); });
  on("clicked:dex", info => { rollAbility("d20", "dex"); });
  on("clicked:con", info => { rollAbility("d20", "con"); });
  on("clicked:int", info => { rollAbility("d20", "int"); });
  on("clicked:psy", info => { rollAbility("d20", "psy"); });
  on("clicked:ego", info => { rollAbility("d20", "ego"); });

  on("clicked:repeating_item:item", info => {
    getAttrs(["repeating_item_die"], values => {
      rollItem(values.repeating_item_die, "Item");
    });
  });

  let specialrules_map = {
    "truekin": "PURE OF BLOOD\nDo not roll mutations during character creation. You gain Advantage on reaction rolls when you encounter other true-kin. You lose this bonus if you ever become visibly mutated.\n\nINHERITOR\nWhenever you encounter pre-Collapse security systems or guard synths, there is a 50% chance that they will recognise you as their master.",
    "synth": "SYNTHETIC FLESH\nYou are a being of metal and plastic. You do not need to eat or breathe. You will never take damage from suffocation, drowning, poisons, extreme temperatures, or fungal spores. You suffer double damage from electrical weapons.\n\nSYNTHETIC MIND\nYou are vulnerable to attacks that target the LogLang syntax that powers synths. These include strobing basilisk patterns, malicious infoglyphs, and ancient Titan-era language viruses.",
    "newbeast": "BEASTHOOD\nYou gain Advantage on saves whenever it would make sense for your animal nature to provide it.  Your Referee may impose Disadvantage in circumstances where your animal nature might prove unhelpful.",
    "mycomorph": "TWICE BORN\nYou are formed from fungus and the corpse of a human. You may make INT saves to recall information that your original body knew. This might include information that has otherwise been lost during the Great Collapse.\n\nDETRITIVORE\nYou can consume organic matter in any abilitye of decay and gain nourishment from it. You heal double HP from Short Rests if the meal you eat is rotting.",
    "cacogen": "CORRUPTED BLOOD\nYou must roll for mutations during character creation. You will find d100 mutations on the following spread. Negotiate with the Referee what these mutations mean in play. In general, mutations do not have hard mechanical rules attached to them. They are likely to grant you Advantage on saves in some situations, and Disadvantage on saves in other circumstances.",
  };

  on("change:ancestry sheet:opened", function() {
    getAttrs(["ancestry"], values => {
      let ancestry = values.ancestry;
      let specialrules = specialrules_map[ancestry];
      setAttrs({
        "specialrules": specialrules
      });
    });
  });

  on("change:str_bonus change:dex_bonus change:con_bonus change:int_bonus change:psy_bonus change:ego_bonus change:str_penalty change:dex_penalty change:con_penalty change:int_penalty change:psy_penalty change:ego_penalty sheet:opened", () => {
    const attributes = [
      "str_bonus", "dex_bonus", "con_bonus", "int_bonus", "psy_bonus", "ego_bonus",
      "str_penalty", "dex_penalty", "con_penalty", "int_penalty", "psy_penalty", "ego_penalty",
    ];
    getAttrs(attributes, values => {
      setAttrs({
        "str_def": parseInt(values.str_bonus) + parseInt(values.str_penalty) + 10,
        "dex_def": parseInt(values.dex_bonus) + parseInt(values.dex_penalty) + 10,
        "con_def": parseInt(values.con_bonus) + parseInt(values.con_penalty) + 10,
        "int_def": parseInt(values.int_bonus) + parseInt(values.int_penalty) + 10,
        "psy_def": parseInt(values.psy_bonus) + parseInt(values.psy_penalty) + 10,
        "ego_def": parseInt(values.ego_bonus) + parseInt(values.ego_penalty) + 10,
      });
    });
  });

  on("change:con_def change:repeating_item remove:repeating_item sheet:opened", () => {
    getAttrs(["con_def"], values => {
      let con_def = values.con_def;
      let slot_attrs = [];
      let count = 0;
      let encumbered = 0;
      let overloaded = 0;
      let item_type = "";

      getSectionIDs("repeating_item", ids => {
        // calculate encumbrance
        ids.forEach(id => {
          slot_attrs.push("repeating_item_" + id + "_item_slots");
        });

        getAttrs(slot_attrs, values => {
          slot_attrs.forEach(attr => {
            if (values[attr]) {
              count += parseInt(values[attr]);
            } else {
              count += 1;
            }
          });

          if (count > con_def) {
            encumbered = 1;
          }
          if (count > 20) {
            overloaded = 1;
          }
          setAttrs({
            "item_count": count,
            "item_encumbered": encumbered,
            "item_overloaded": overloaded,
          });
        });
      });
    });
  });
</script>
