<div class="vaarn-character">
  <div class="header">
    <label class="very-large">VAULTS of VAARN</label>
  </div>

  <div class="basics">
    <label>NAME</label><input type="text" name="attr_name"/><br/>

    <label>ANCESTRY</label><select type="text" name="attr_ancestry">
      <option value="truekin">True-Kin</option>
      <option value="synth">Synth</option>
      <option value="newbeast">Newbeast</option>
      <option value="mycomorph">Mycomorph</option>
      <option value="cacogen">Cacogen</option>
    </select>
    <br/>

    <div class="sheet-auto-expand">
      <span name="attr_specialrules"></span>
      <textarea spellcheck="false" name="attr_specialrules"></textarea>
    </div>
  </div>
  
  <div class="bio">
    <label>HP</label><input type="number" name="attr_hp_cur"/>
    <span class="spacer">&nbsp;</span>
    <label>LEVEL</label><input type="number" name="attr_level"/>
    <br/>

    <label>MAX</label><input type="number" name="attr_hp_max"/>
    <span class="spacer">&nbsp;</span>
    <label>XP</label><input type="number" name="attr_xp"/>
    <br/>

    <div class="sheet-auto-expand">
      <span name="attr_bio"></span>
      <textarea spellcheck="false" name="attr_bio" placeholder="bio"></textarea>
    </div>
  </div>

  <div class="clear"></div>

  <div class="header">
    <label class="large">ABILITIES</label>
  </div>

  <div class="labels">
    <label>&nbsp;</label></br>
    <label>BONUS</label></br>
    <label>DEF</label></br>
    <label class="small">CYBERNETIC</label>
  </div>

  <div class="ability">
    <label>STR</label><br/>
    <input type="number" min="1" max="10" name="attr_str_bonus"/><br/>
    <input type="number" min="3" max="20" name="attr_str_def" readonly/><br/>
    <div class="sheet-auto-expand">
      <span name="attr_str_cybernetic"></span>
      <textarea spellcheck="false" name="attr_str_cybernetic"></textarea>
    </div>
  </div>

  <div class="ability">
    <label>DEX</label><br/>
    <input type="number" min="1" max="10" name="attr_dex_bonus"/><br/>
    <input type="number" min="3" max="20" name="attr_dex_def" readonly/><br/>
    <div class="sheet-auto-expand">
      <span name="attr_dex_cybernetic"></span>
      <textarea spellcheck="false" name="attr_dex_cybernetic"></textarea>
    </div>
  </div>

  <div class="ability">
    <label>CON</label><br/>
    <input type="number" min="1" max="10" name="attr_con_bonus"/><br/>
    <input type="number" min="3" max="20" name="attr_con_def" readonly/><br/>
    <div class="sheet-auto-expand">
      <span name="attr_con_cybernetic"></span>
      <textarea spellcheck="false" name="attr_con_cybernetic"></textarea>
    </div>
  </div>

  <div class="ability">
    <label>INT</label><br/>
    <input type="number" min="1" max="10" name="attr_int_bonus"/><br/>
    <input type="number" min="3" max="20" name="attr_int_def" readonly/><br/>
    <div class="sheet-auto-expand">
      <span name="attr_int_cybernetic"></span>
      <textarea spellcheck="false" name="attr_int_cybernetic"></textarea>
    </div>
  </div>

  <div class="ability">
    <label>PSY</label><br/>
    <input type="number" min="1" max="10" name="attr_psy_bonus"/><br/>
    <input type="number" min="3" max="20" name="attr_psy_def" readonly/><br/>
    <div class="sheet-auto-expand">
      <span name="attr_psy_cybernetic"></span>
      <textarea spellcheck="false" name="attr_psy_cybernetic"></textarea>
    </div>
  </div>

  <div class="ability">
    <label>EGO</label><br/>
    <input type="number" min="1" max="10" name="attr_ego_bonus"/><br/>
    <input type="number" min="3" max="20" name="attr_ego_def" readonly/><br/>
    <div class="sheet-auto-expand">
      <span name="attr_ego_cybernetic"></span>
      <textarea spellcheck="false" name="attr_ego_cybernetic"></textarea>
    </div>
  </div>

  <div class="clear"></div>

  <div class="header">
    <label class="large">ITEMS</label>
  </div>

  <div class="item">
    <input type="hidden" class="item-count" name="attr_item_count"></input>
    <input type="hidden" class="item-encumbered" name="attr_item_encumbered" max="0"></input>
    <input type="hidden" class="item-overloaded" name="attr_item_overloaded" max="0"></input>
    <fieldset class="repeating_item">
      <input type="hidden" name="attr_item_slots" class="item-slots-hidden"/>
      <label></label><input type="text" name="attr_item_name" class="item-name"/><select name="attr_item_type" class="item-type">
        <option value="item">Item</option>
        <option value="gift">Mystic Gift</option>
        <option value="wound">Wound</option>
      </select><input type="number" name="attr_item_slots" class="item-slots" min="1" max="10" placeholder="slots"/><span class="spacer"><button disabled>&nbsp;</button><button disabled>&nbsp;</button></span>
    </fieldset>
  </div>

  <div class="header">
    <label class="large">NOTES</label>
  </div>

  <div class="notes">
    <div class="sheet-auto-expand">
      <span name="attr_notes"></span>
      <textarea spellcheck="false" name="attr_notes"></textarea>
    </div>
  </div>
</div>

<script type="text/worker">
  let specialrules_map = {
    "truekin": "PURE OF BLOOD\nDo not roll mutations during character creation. You gain Advantage on reaction rolls when you encounter other true-kin. You lose this bonus if you ever become visibly mutated.\n\nINHERITOR\nWhenever you encounter pre-Collapse security systems or guard synths, there is a 50% chance that they will recognise you as their master.",
    "synth": "SYNTHETIC FLESH\nYou are a being of metal and plastic. You do not need to eat or breathe. You will never take damage from suffocation, drowning, poisons, extreme temperatures, or fungal spores. You suffer double damage from electrical weapons.\n\nSYNTHETIC MIND\nYou are vulnerable to attacks that target the LogLang syntax that powers synths. These include strobing basilisk patterns, malicious infoglyphs, and ancient Titan-era language viruses.",
    "newbeast": "BEASTHOOD\nYou gain Advantage on saves whenever it would make sense for your animal nature to provide it.  Your Referee may impose Disadvantage in circumstances where your animal nature might prove unhelpful.",
    "mycomorph": "TWICE BORN\nYou are formed from fungus and the corpse of a human. You may make INT saves to recall information that your original body knew. This might include information that has otherwise been lost during the Great Collapse.\n\nDETRITIVORE\nYou can consume organic matter in any abilitye of decay and gain nourishment from it. You heal double HP from Short Rests if the meal you eat is rotting.",
    "cacogen": "CORRUPTED BLOOD\nYou must roll for mutations during character creation. You will find d100 mutations on the following spread. Negotiate with the Referee what these mutations mean in play. In general, mutations do not have hard mechanical rules attached to them. They are likely to grant you Advantage on saves in some situations, and Disadvantage on saves in other circumstances.",
  };

  on("change:ancestry sheet:opened", function() {
    getAttrs(["ancestry"], values => {
      let ancestry = values.ancestry;
      let specialrules = specialrules_map[ancestry];
      setAttrs({
        "specialrules": specialrules
      });
    });
  });

  on("change:str_bonus change:dex_bonus change:con_bonus change:int_bonus change:psy_bonus change:ego_bonus sheet:opened", () => {
    getAttrs(["str_bonus", "dex_bonus", "con_bonus", "int_bonus", "psy_bonus", "ego_bonus"], values => {
      setAttrs({
        "str_def": parseInt(values.str_bonus) + 10,
        "dex_def": parseInt(values.dex_bonus) + 10,
        "con_def": parseInt(values.con_bonus) + 10,
        "int_def": parseInt(values.int_bonus) + 10,
        "psy_def": parseInt(values.psy_bonus) + 10,
        "ego_def": parseInt(values.ego_bonus) + 10,
      });
    });
  });

  on("change:con_def change:repeating_item remove:repeating_item sheet:opened", () => {
    getAttrs(["con_def"], values => {
      let con_def = values.con_def;
      let slot_attrs = []
      let count = 0;
      let encumbered = 0;
      let overloaded = 0;

      getSectionIDs("repeating_item", ids => {
        ids.forEach(id => {
          slot_attrs.push("repeating_item_" + id + "_item_slots");
        });

        getAttrs(slot_attrs, values => {
          slot_attrs.forEach(attr => {
            if (values[attr]) {
              count += parseInt(values[attr]);
            } else {
              count += 1;
            }
          });

          if (count > con_def) {
            encumbered = 1;
          }
          if (count > 20) {
            overloaded = 1;
          }
          setAttrs({
            "item_count": count,
            "item_encumbered": encumbered,
            "item_overloaded": overloaded,
          });
        });
      });
    });
  });
</script>
